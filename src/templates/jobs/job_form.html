{% extends 'base.html' %}

{% block title %}{{ title }} - CasualJobs{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-plus-circle"></i> {{ title }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <!-- Thông báo thông tin điền sẵn - chỉ hiển thị khi tạo mới -->
                        {% if not job %}
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Một số thông tin đã được điền sẵn từ hồ sơ của bạn. Bạn có thể chỉnh sửa nếu cần.
                        </div>
                        {% endif %}
                        
                        <!-- Thông báo về việc tự động mở lại job khi cập nhật thời gian làm việc - chỉ hiển thị khi chỉnh sửa job đã đóng hoặc hết hạn -->
                        {% if job and job.status == 'closed' or job.status == 'expired' %}
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Lưu ý:</strong> Công việc này hiện đang ở trạng thái <strong>{{ job.get_status_display }}</strong>. 
                            Nếu bạn cập nhật thời gian làm việc và thời gian mới vẫn còn hạn (sau thời điểm hiện tại), 
                            công việc sẽ tự động được mở lại và chuyển về trạng thái <strong>Đã đăng</strong>.
                        </div>
                        {% endif %}
                        
                        <!-- Thông tin cơ bản -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-info-circle"></i> Thông tin cơ bản
                                </h6>
                            </div>
                            
                            <div class="col-12">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    Tiêu đề công việc <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.category.id_for_label }}" class="form-label">
                                    Danh mục công việc <span class="text-danger">*</span>
                                </label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.category.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                    Độ ưu tiên
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.priority.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Mô tả chi tiết <span class="text-danger">*</span>
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.description.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Địa điểm và thời gian -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-geo-alt"></i> Địa điểm và thời gian
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.location.id_for_label }}" class="form-label">
                                    Địa điểm làm việc <span class="text-danger">*</span>
                                </label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.location.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Địa chỉ làm việc cụ thể. Đã được điền từ hồ sơ của bạn nếu có sẵn.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.work_date.id_for_label }}" class="form-label">
                                    Ngày làm việc <span class="text-danger">*</span>
                                </label>
                                {{ form.work_date }}
                                {% if form.work_date.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.work_date.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">
                                    Giờ bắt đầu <span class="text-danger">*</span>
                                </label>
                                <div class="row g-2">
                                    <div class="col">
                                        {{ form.work_time_start_hour }}
                                        <small class="form-text d-block text-center">Giờ</small>
                                    </div>
                                    <div class="col">
                                        {{ form.work_time_start_minute }}
                                        <small class="form-text d-block text-center">Phút</small>
                                    </div>
                                </div>
                                {{ form.work_time_start }}
                                {{ form.work_time_start_str }}
                                {% if form.work_time_start_hour.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.work_time_start_hour.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">
                                    Giờ kết thúc <span class="text-danger">*</span>
                                </label>
                                <div class="row g-2">
                                    <div class="col">
                                        {{ form.work_time_end_hour }}
                                        <small class="form-text d-block text-center">Giờ</small>
                                    </div>
                                    <div class="col">
                                        {{ form.work_time_end_minute }}
                                        <small class="form-text d-block text-center">Phút</small>
                                    </div>
                                </div>
                                {{ form.work_time_end }}
                                {{ form.work_time_end_str }}
                                {% if form.work_time_end_hour.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.work_time_end_hour.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.duration_hours.id_for_label }}" class="form-label">
                                    Số giờ làm việc <span class="text-danger">*</span>
                                </label>
                                {{ form.duration_hours }}
                                {% if form.duration_hours.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.duration_hours.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Lương và thanh toán -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-currency-dollar"></i> Lương và thanh toán
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.payment_type.id_for_label }}" class="form-label">
                                    Hình thức trả lương <span class="text-danger">*</span>
                                </label>
                                {{ form.payment_type }}
                                {% if form.payment_type.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.payment_type.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.payment_amount.id_for_label }}" class="form-label">
                                    Mức lương (VND) <span class="text-danger">*</span>
                                </label>
                                {{ form.payment_amount }}
                                {% if form.payment_amount.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.payment_amount.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Yêu cầu công việc -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-person-check"></i> Yêu cầu công việc
                                </h6>
                            </div>
                            
                            <div class="col-12">
                                <label for="{{ form.required_skills.id_for_label }}" class="form-label">
                                    Kỹ năng yêu cầu
                                </label>
                                {{ form.required_skills }}
                                {% if form.required_skills.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.required_skills.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Ví dụ: Pha chế, Phục vụ khách hàng, Tiếng Anh cơ bản
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.experience_required.id_for_label }}" class="form-label">
                                    Số năm kinh nghiệm
                                </label>
                                {{ form.experience_required }}
                                {% if form.experience_required.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.experience_required.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.number_of_workers.id_for_label }}" class="form-label">
                                    Số lượng cần tuyển <span class="text-danger">*</span>
                                </label>
                                {{ form.number_of_workers }}
                                {% if form.number_of_workers.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.number_of_workers.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Thông tin liên hệ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-telephone"></i> Thông tin liên hệ
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.contact_phone.id_for_label }}" class="form-label">
                                    Số điện thoại liên hệ
                                </label>
                                {{ form.contact_phone }}
                                {% if form.contact_phone.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.contact_phone.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Số điện thoại để ứng viên liên hệ. Đã được điền từ hồ sơ của bạn.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.contact_email.id_for_label }}" class="form-label">
                                    Email liên hệ
                                </label>
                                {{ form.contact_email }}
                                {% if form.contact_email.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.contact_email.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Email để ứng viên liên hệ. Đã được điền từ hồ sơ của bạn.
                                </div>
                            </div>
                            
                            <!-- Đã loại bỏ trường Hạn nộp đơn - Sẽ tự động lấy theo thời gian bắt đầu công việc -->
                        </div>
                        
                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'jobs:job_list' %}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Hủy
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 
                                {% if job %}Cập nhật việc làm{% else %}Đăng việc làm{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script để tính số giờ làm việc tự động -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const startHourSelect = document.getElementById('id_work_time_start_hour');
        const startMinuteSelect = document.getElementById('id_work_time_start_minute');
        const endHourSelect = document.getElementById('id_work_time_end_hour');
        const endMinuteSelect = document.getElementById('id_work_time_end_minute');
        const durationField = document.getElementById('id_duration_hours');
        const hiddenStartTimeStr = document.getElementById('id_work_time_start_str');
        const hiddenEndTimeStr = document.getElementById('id_work_time_end_str');
        const hiddenStartTime = document.getElementById('id_work_time_start');
        const hiddenEndTime = document.getElementById('id_work_time_end');
        
        function updateTimeString() {
            if (startHourSelect.value && startMinuteSelect.value) {
                const startTimeStr = `${startHourSelect.value}:${startMinuteSelect.value}`;
                hiddenStartTimeStr.value = startTimeStr;
            }
            
            if (endHourSelect.value && endMinuteSelect.value) {
                const endTimeStr = `${endHourSelect.value}:${endMinuteSelect.value}`;
                hiddenEndTimeStr.value = endTimeStr;
            }
        }
        
        function calculateDuration() {
            if (startHourSelect.value && startMinuteSelect.value && endHourSelect.value && endMinuteSelect.value) {
                // Parse the time values
                const startHour = parseInt(startHourSelect.value);
                const startMinute = parseInt(startMinuteSelect.value);
                const endHour = parseInt(endHourSelect.value);
                const endMinute = parseInt(endMinuteSelect.value);
                
                // Convert to minutes since midnight
                const startMinutes = startHour * 60 + startMinute;
                let endMinutes = endHour * 60 + endMinute;
                
                // Handle case where end time is on the next day
                if (endMinutes < startMinutes) {
                    endMinutes += 24 * 60; // Add 24 hours
                }
                
                // Calculate duration in hours (with 2 decimal places)
                const durationHours = ((endMinutes - startMinutes) / 60).toFixed(2);
                durationField.value = durationHours;
                
                // Update hidden fields
                updateTimeString();
            }
        }
        
        // Add event listeners
        if (startHourSelect && startMinuteSelect && endHourSelect && endMinuteSelect && durationField) {
            startHourSelect.addEventListener('change', calculateDuration);
            startMinuteSelect.addEventListener('change', calculateDuration);
            endHourSelect.addEventListener('change', calculateDuration);
            endMinuteSelect.addEventListener('change', calculateDuration);
            
            // Initial calculation if values exist
            updateTimeString();
            calculateDuration();
        }
    });
</script>
{% endblock %}